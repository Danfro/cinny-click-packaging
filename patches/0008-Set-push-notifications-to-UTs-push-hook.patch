From 4305381292b98fff780bef159014076897569e74 Mon Sep 17 00:00:00 2001
From: Marcel Alexandru Nitan <nitan.marcel@protonmail.com>
Date: Thu, 16 Jun 2022 16:05:12 +0300
Subject: [PATCH] Set push notifications to UTs push hook

---
 src/client/initMatrix.js | 31 +++++++++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/src/client/initMatrix.js b/src/client/initMatrix.js
index aec2f3d..23c7598 100644
--- a/src/client/initMatrix.js
+++ b/src/client/initMatrix.js
@@ -2,6 +2,7 @@ import EventEmitter from 'events';
 import * as sdk from 'matrix-js-sdk';
 // import { logger } from 'matrix-js-sdk/lib/logger';
 
+import { cons } from './state/cons';
 import { secret } from './state/auth';
 import RoomList from './state/RoomList';
 import AccountData from './state/AccountData';
@@ -18,6 +19,12 @@ class InitMatrix extends EventEmitter {
     await this.startClient();
     this.setupSync();
     this.listenEvents();
+
+    this.setPush(QML.settings.pushToken, QML.settings.pushAppId)
+    QML.matrixPushTokenChanged.connect(async function (token) {
+      this.setPush(token, QML.settings.pushAppId)
+
+    });
   }
 
   async startClient() {
@@ -51,6 +58,30 @@ class InitMatrix extends EventEmitter {
     this.matrixClient.setGlobalErrorOnUnknownDevices(false);
   }
 
+  setPush(token, appId) {
+    const promises = []
+
+    promises.push(
+    this.matrixClient.setPusher(
+      {
+        "app_display_name": cons.DEVICE_DISPLAY_NAME,
+        "app_id": appId,
+        "append": true,
+        "data": {
+            "url": "https://push.ubports.com:5003/_matrix/push/v1/notify"
+        },
+        "device_display_name": cons.DEVICE_DISPLAY_NAME,
+        "lang": "en",
+        "kind": "http",
+        "profile_tag": "xxyyzz",
+        "pushkey": token
+      }
+    ));
+    promises.push(this.matrixClient.setPushRuleEnabled('global', 'content', '.m.rule.contains_user_name', true));
+    console.error("Set appID " + appId + "with token " + token)
+    return Promise.all(promises);
+  }
+
   setupSync() {
     const sync = {
       NULL: () => {
-- 
2.30.2

